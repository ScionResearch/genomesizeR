---
title: "genomesizeR: Genome size prediction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{genomesizeR}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

## Introduction

The purpose of this R package is to implement tools that allow the inference of genome size based on taxonomic information and available genome data from the NCBI.

This R package offers three different methods for genome size prediction.

The methods use: 

  - A list of queries; a query being a taxon or a list of several taxa. 
  - A reference database containing all the known genome sizes, built from the NCBI databases, with associated taxa. The database is variably dense depending on the taxon groups. 
  - A taxonomic tree structure as built by the NCBI, imperfectly reflecting the evolutionary distances between taxa, depending on the taxa/subtree. 

`genomesizeR` estimates the genome size of each query, with a confidence interval on the estimation. 

## Methods

### Frequentist hierarchical model (lmm)

A hierarchical linear random-effects model using the lmer function from the lme4 package, based on the known genome sizes at the genus and family levels as follows:

lmer(log(genome_size) ~ (1|family/genus), data)

A 95% prediction interval is computed using the predictInterval function from the merTools package. 


### Bayesian method

A Bayesian linear hierarchical model was fitted to data from each superkingdom (Bacteria, Archeae, Eukaryotes) using the brm function from the brms package, following the model below:

\begin{equation}
log(G) \sim \mathcal{N}(\mu, \sigma^2) \\
\mu = \mu_0 + \alpha_{genus} \\
\alpha_{genus} \sim \mathcal{N}(\alpha_{family}, \sigma_{genus}^2) \\
\alpha_{family} \sim \mathcal{N}(\alpha_{order}, \sigma_{family}^2) \\
\alpha_{order} \sim \mathcal{N}(\alpha_{class}, \sigma_{order}^2) \\
\alpha_{class} \sim \mathcal{N}(\alpha_{phylum}, \sigma_{class}^2) \\
\alpha_{phylum} \sim \mathcal{N}(0, \sigma_{phylum}^2) \\
\mu_0 \sim \mathcal{N}(0,5) \\
(\sigma,\sigma_{genus},\sigma_{family},\sigma_{order},\sigma_{class},\sigma_{phylum}) \sim \mathcal{N}^+(0,1) \\
\end{equation}

where $G$ is the genome size in the units of 10 Mbp and $\mathcal{N}^+$ is the normal distribution truncated to positive values.

The estimation process uses Stan's Hamiltonian Monte Carlo algorithm with the U-turn sampler. 95% credible intervals are obtained using quantiles from the posterior distribution for each prediction.


### Weighted mean method

The weighted mean method computes the genome size of a query by averaging the known genome sizes of surrounding taxa in the taxonomic tree, with a weighted system where further neighbours have less weight in the computed mean.

The 95% confidence interval is calculated as:

```
  standard_error = sqrt(computed_weighted_mean)
  Z = 1.96
  confidence_interval = Z * standard_error
```

## Implementation

The main steps of both methods are multithreaded on POSIX systems (not Windows). 

The R package accepts the dada2 format, as well as the BIOM format, used by mothur and phyloseq, and any file or dataframe with a colum containing either NCBI taxids or taxon names as input formats. The output format is a data frame with the same columns as the input, with some added columns providing information about the estimation and the quality of the estimation. The user can also choose a simple output format only containing the estimation information. 

## Examples

#### Example using default bayesian method on example file:

```
  results = estimate_genome_size(example_input_file, format='csv', sep='\t', match_column='TAXID', output_format='input')

#############################################################################
# Genome size estimation summary:
#
#  8.888889 % estimations achieving required precision
#
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
  2893119   5344026  17768591  24126621  42194240 128877284 

# Estimation status:
Confidence interval to estimated size ratio > ci_threshold                                                         OK 
                                                       164                                                         16
```

#### Plot genome size histogram per sample:

```{r, echo = FALSE}
  library(genomesizeR)
  example_output_file = system.file("extdata", "results_bayesian.csv", package = "genomesizeR")
  results = read.csv2(example_output_file, sep=',', dec = '.')
```

```{r, echo = TRUE}
  plotted_df = plot_genome_size_histogram(results)
```

#### Plot genome size histogram for one sample:

```{r, echo = TRUE}
  plotted_df = plot_genome_size_histogram(results, only_sample='16S_1')
```

#### Plot genome size boxplot per sample:

```{r, echo = TRUE}
  plotted_df = plot_genome_size_boxplot(results)
```

#### Plot genome size boxplot for one sample:

```{r, echo = TRUE}
  plotted_df = plot_genome_size_boxplot(results, only_sample='ITS_1')
```

#### Plot simplified taxonomic tree with colour-coded estimated genome sizes:

```{r, echo = TRUE, fig.width= 22, fig.height= 22}
  plotted_df = plot_genome_size_tree(results)
```
